import SwiftUI
import SceneKit

struct GameView: UIViewRepresentable {
    let playerName: String
    let carType: String
    let driverType: String

    func makeUIView(context: Context) -> SCNView {
        let view = SCNView()
        view.scene = SCNScene()
        view.allowsCameraControl = false
        view.showsStatistics = true
        view.backgroundColor = .black

        context.coordinator.setup(
            scene: view.scene!,
            carType: carType,
            driverType: driverType
        )

        view.delegate = context.coordinator
        view.isPlaying = true
        return view
    }

    func updateUIView(_ uiView: SCNView, context: Context) {}

    func makeCoordinator() -> Coordinator { Coordinator() }

    class Coordinator: NSObject, SCNSceneRendererDelegate {
        var car = SCNNode()
        var cameraNode = SCNNode()

        var speed: Float = 0
        var steering: Float = 0

        var maxSpeed: Float = 40
        var accel: Float = 20
        var grip: Float = 1

        func setup(scene: SCNScene, carType: String, driverType: String) {
            if carType == "Sport" { maxSpeed = 55; accel = 22; grip = 0.9 }
            if carType == "Muscle" { maxSpeed = 45; accel = 26; grip = 0.8 }
            if carType == "Kart" { maxSpeed = 30; accel = 16; grip = 1.2 }

            if driverType == "Aggressive" { grip *= 0.8 }
            if driverType == "Smooth" { grip *= 1.1 }

            let floor = SCNFloor()
            floor.reflectivity = 0
            let floorNode = SCNNode(geometry: floor)
            floorNode.geometry?.firstMaterial?.diffuse.contents = UIColor.darkGray
            scene.rootNode.addChildNode(floorNode)

            let body = SCNBox(width: 1.2, height: 0.4, length: 2.0, chamferRadius: 0.1)
            body.firstMaterial?.diffuse.contents = UIColor.red
            car = SCNNode(geometry: body)
            car.position = SCNVector3(0, 0.3, 0)
            scene.rootNode.addChildNode(car)

            let cam = SCNCamera()
            cameraNode.camera = cam
            cameraNode.position = SCNVector3(0, 3, 8)
            scene.rootNode.addChildNode(cameraNode)

            let light = SCNLight()
            light.type = .directional
            let lightNode = SCNNode()
            lightNode.light = light
            lightNode.eulerAngles = SCNVector3(-.pi/3, 0, 0)
            scene.rootNode.addChildNode(lightNode)
        }

        func renderer(_ renderer: SCNSceneRenderer, updateAtTime time: TimeInterval) {
            let dt: Float = 1/60

            let throttle: Float = 0
            let steerInput: Float = 0

            speed = move(speed, toward: throttle * maxSpeed, by: accel * dt)
            speed = max(min(speed, maxSpeed), -maxSpeed)

            let moveVec = SCNVector3(
                -sin(car.eulerAngles.y) * speed * dt,
                0,
                -cos(car.eulerAngles.y) * speed * dt
            )
            car.position.x += moveVec.x
            car.position.z += moveVec.z

            car.eulerAngles.y += steerInput * (speed/maxSpeed) * grip * dt * 2

            let camTarget = car.position + SCNVector3(0,3,8)
            cameraNode.position = cameraNode.position.lerp(to: camTarget, t: 0.1)
            cameraNode.look(at: car.position)
        }

        func move(_ current: Float, toward target: Float, by maxDelta: Float) -> Float {
            if abs(target - current) <= maxDelta { return target }
            return current + (target > current ? maxDelta : -maxDelta)
        }
    }
}

extension SCNVector3 {
    static func + (a: SCNVector3, b: SCNVector3) -> SCNVector3 {
        SCNVector3(a.x+b.x, a.y+b.y, a.z+b.z)
    }
    func lerp(to: SCNVector3, t: Float) -> SCNVector3 {
        SCNVector3(
            x + (to.x - x) * t,
            y + (to.y - y) * t,
            z + (to.z - z) * t
        )
    }
}

